# TODO

## UI

- [ ] Logo 太大了，自己找一个 logo
- [ ] 页面流程梳理
- [x] 正确的工作逻辑梳理

## Workflows

水作业的流程：

1. 用户只能登录或者注销，不能注册，不能开户，不能删除账户。
2. 银行职员负责开户和删除，并且是直接删除。告诉用户名和密码。
3. 用户转账直接给用户转账，不区分账户。
4. 查看 balance 就直接请求然后查看就是。

对于普通用户，就一个登录页面（一开始提供的），登录之后跳转到 dashboard 页面，在某个地方显示登录的用户名，旁边提示可以注销，并且在某处可以显示账户余额。dashboard 可以切换到 balance 页面（这里也记录转账的历史），或者其实 balance 和转账页面共用一部分元素，比如历史记录这种。

对于银行职员，登录之后跳转到 dashboard 页面，在某个地方显示登录的用户名，旁边提示可以注销，并且在某处可以显示账户余额。另外，还有一个开户的按钮，点击之后跳转到开户页面，填写用户名和密码，然后点击提交，跳转到 dashboard 页面，提示开户成功，显示开户的用户名。删除账户同理。

---

一个更符合逻辑的流程：

> 不区分不同类型人群的队列，一个队列中按用户类别分优先级排列。

### 注册

1. 任何人可以注册，但一定需要一个银行职员来处理这个注册流程。
2. 注册的时候需要提供用户名，邮箱，姓名，密码，以及一个转账地址。
   1. 除了用户名密码邮箱，别的都是可选的。
   2. 没有提供转账地址的用户是没有办法进行交易的。
   3. 转账地址可以从银行获取一个。
3. 密码需要被加密。注册时，服务端需要生成一个盐值，并和明文密码组合之后进行 hash，然后存储到数据库中。（盐值，hash 后的密码）
4. 定期对数据库中的密码进行更新，以防止泄露。方案是在登录验证之后，如果发现盐值的时间戳已经过期，那么就重新生成一个盐值，然后更新数据库中的盐值和密码。
5. 银行职员需要在 dashboard 接受通知，包括 customer 待注册队列中的用户，银行职员需要审核，审核后会记录审核人员的 id。审核通过会邮件通知用户。除了用户名的审核会直接导致注册失败之外，别的审核异常情况，可以暂存信息，等待注册成功后的用户自行修改正确，这个异常信息应该是一个表中的字段。
6. 用户如果修改了自己的信息，将加入 customer 待审核列表，等待银行职员审核后生效。待审核列表记录的数据结构需要包括每个字段的旧值和新值，旧值必须存在，新值如果为 null 说明没有修改。旧值一定是持久化后在数据库中存在的值，这是为了避免连续两次加入审核队列之后导致的数据不一致问题。

### 开户

除了用户直接注册后等待职员审核之外，还可以直接由职员开户。和用户自己注册不同，用户自己注册只能注册 customer 账户

- 这个过程中，如果是 customer，就和上面的流程没有什么不同，除了一开始直接不需要加入待注册队列。
- 如果是 clerk 账户，开户人员自己就算是审核了一次，然后需要另外一个 clerk 完成一次审核。这个过程中，需要记录两个审核人员的 id，必须是另一个人。
- 如果是 admin 账户，暂时先不考虑。

### 删除账户

- customer 账户的删除需要两人审核（删除队列），同上文的处理逻辑，用户自己可以决定注销自己的帐号，但删除成功需要两位 clerk 审核。删除之后，这个账户的信息将被记录为 invalid，别的信息，包括账户余额，交易记录等等，仍然持久化在数据库中，根据 invalid 的时间随之时间推移而删除。
- clerk 账户的删除需要 admin 的通过，clerk 可以看到后签名来提供可信度，但不能直接进行删除。
- admin 的删除暂时不提供。

### 登录

- 用户登录的时候，需要提供用户名和密码，如果用户名不存在，或者密码错误，都会导致登录失败。
- 登录成功之后，根据记录用户登录的信息，包括用户的 id，登录时间，登录 ip，登录的 uuid，登录的设备等等。记录在一个登录细节的大表里面，根据 id 区分不同用户。（注意，用户注册的时候也需要记录）
- 登录后服务端维护一个 session，sessionId 需要是一个很长的标识符，难以被仿制，可能用一个哈希表维护，key 是 sessionId，value 是用户的 accountId 和 session 的更新时间（用户上一次操作的时间），另外还需要维护一个哈希表，通过 accountId 来查找该用户当前的登录情况，value 可以是一个 Vector，元素是维护当前用户登录信息的一个结构体，包括 sessionId，sessionCreateTime，用户 id，登录时间，登录 ip，登录的 uuid，登录的设备等等。
- 可以考虑维护一个 session 结构啥的。
- 用户请求需要随时带上这个 sessionId

### 登出

- session 有一个过期时间，如果用户在过期时间内（初步考虑 1h，测试时 1min）没有进行任何操作，那么 session 就会过期，用户需要重新登录。用户发送任何请求都可以更新 sessionUpdateTime。
- 用户可以主动选择登出，发出登出请求之后服务端会删除这个 session，并持久化到数据库中，登录持续时间也会被记录到数据库中。

### 查看余额

- 用户可以查看自己的个人信息，包括不同地址的余额，以及交易记录。个人信息界面可以跳转到交易记录界面（因为可能会很多细节）。交易记录界面需要允许不同的筛选条件，比如时间，交易对象，交易金额等等，选择条件中可以有选择几个地址，或者全选（默认全选）。
- 服务端处理的时候，因为交易记录相当于又是一张大表，通过 from-to 的账户地址来记录，记录一个交易的具体细节，包括交易时间，数额。账户细节则通过另一张专门记录账户地址和用户地址的表来查。

### 转账

用户可以选择给指定账户转账。

- 转账的时候需要提供转账金额，转账地址。
- 转账地址需要在数据库中存在，否则转账失败。
- 转账时，需要记录的内容（就是转账表的表项）：from to 的地址，交易时间，数额。
